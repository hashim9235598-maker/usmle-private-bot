import telebot
import os
import json
import openai
from datetime import datetime

# ======== Environment Variables ========
TOKEN = os.getenv("TOKEN")             # Telegram bot token
OPENAI_KEY = os.getenv("OPENAI_KEY")   # OpenAI API key
openai.api_key = OPENAI_KEY

bot = telebot.TeleBot(TOKEN)

# ======== File to track progress ========
PROGRESS_FILE = "progress.json"

# Initialize progress file if not exists
if not os.path.exists(PROGRESS_FILE):
    with open(PROGRESS_FILE, "w") as f:
        json.dump({}, f)

# ======== Step 1 Daily Plan ========
DAILY_PLAN = [
    "1ï¸âƒ£ Cell Injury",
    "2ï¸âƒ£ Necrosis & Apoptosis",
    "3ï¸âƒ£ Inflammation",
    "4ï¸âƒ£ Healing & Repair",
    "5ï¸âƒ£ 10 MCQs on today's topics"
]

# ======== Helper Functions ========
def load_progress():
    with open(PROGRESS_FILE, "r") as f:
        return json.load(f)

def save_progress(data):
    with open(PROGRESS_FILE, "w") as f:
        json.dump(data, f, indent=2)

def generate_ai_answer(question):
    response = openai.Completion.create(
        engine="text-davinci-003",
        prompt=f"Ø§Ø´Ø±Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Step 1 Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¨Ø³Ø·Ø© ÙˆØ¹Ù…Ù„ÙŠÙ‘Ø©: {question}",
        max_tokens=300
    )
    return response.choices[0].text.strip()

# ======== Bot Commands ========
@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message,
        "ğŸ”¥ USMLE MODE ACTIVATED ğŸ”¥\n"
        "Ø§ÙƒØªØ¨ /plan Ù„Ø±Ø¤ÙŠØ© Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…\n"
        "Ø§ÙƒØªØ¨ /done Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… Ø£ÙŠ Ø®Ø·ÙˆØ©\n"
        "Ø§ÙƒØªØ¨ /ask Ù…ØªØ¨ÙˆØ¹ Ø¨Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø±Ø­ Ø°ÙƒÙŠ"
    )

@bot.message_handler(commands=['plan'])
def send_plan(message):
    plan_text = "ğŸ“š Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…:\n" + "\n".join(DAILY_PLAN)
    bot.reply_to(message, plan_text)

@bot.message_handler(commands=['done'])
def mark_done(message):
    data = load_progress()
    today = datetime.now().strftime("%Y-%m-%d")
    data.setdefault(today, [])
    last_step = message.text.replace("/done", "").strip()
    if last_step:
        data[today].append(last_step)
    else:
        data[today].append("Completed step")
    save_progress(data)
    bot.reply_to(message, "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…")

@bot.message_handler(commands=['progress'])
def show_progress(message):
    data = load_progress()
    today = datetime.now().strftime("%Y-%m-%d")
    today_progress = data.get(today, [])
    if today_progress:
        bot.reply_to(message, f"ğŸ“ˆ ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„ÙŠÙˆÙ… ({today}):\n" + "\n".join(today_progress))
    else:
        bot.reply_to(message, "Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØªÙ‚Ø¯Ù… Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯")

@bot.message_handler(commands=['ask'])
def ask_ai(message):
    question = message.text.replace("/ask","").strip()
    if not question:
        bot.reply_to(message, "Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ /ask")
        return
    bot.reply_to(message, "âŒ› Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© â€¦")
    answer = generate_ai_answer(question)
    bot.reply_to(message, answer)

# ======== Echo for unknown messages ========
@bot.message_handler(func=lambda m: True)
def echo_all(message):
    bot.reply_to(message, "Ø§Ø³ØªØ®Ø¯Ù… /plan Ù„Ø±Ø¤ÙŠØ© Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ØŒ /ask Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠØŒ /done Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…")

# ======== Run Bot ========
bot.infinity_polling()